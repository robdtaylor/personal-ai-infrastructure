#!/bin/bash
#
# pai-hoshin - Hoshin Kanri specific commands for phone SSH
#
# Usage:
#   pai-hoshin status              # Overall status
#   pai-hoshin objective A1        # Check specific objective
#   pai-hoshin bowling A1          # Show bowling chart for A1
#   pai-hoshin a3 list             # List active A3s
#   pai-hoshin review              # Prep for monthly review
#

set -e

PAI_DIR="${HOME}/.claude"
OBSIDIAN_DIR="${HOME}/Documents/personal"
HOSHIN_DIR="${OBSIDIAN_DIR}/Hoshin"
TEMPLATES_DIR="${PAI_DIR}/skills/HoshinKanri/templates"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

usage() {
    echo "PAI Hoshin Kanri Commands"
    echo ""
    echo "Usage: pai-hoshin <command> [args]"
    echo ""
    echo "Commands:"
    echo "  status              - Overall Hoshin status"
    echo "  objective <ID>      - Status of specific objective (A1, A2, etc.)"
    echo "  bowling <ID>        - Show bowling chart"
    echo "  a3 list             - List active A3s"
    echo "  a3 <ID>             - Show specific A3"
    echo "  review              - Prep for monthly review"
    echo "  template <type>     - Show template (x-matrix, bowling, a3, catchball)"
    echo ""
    echo "Examples:"
    echo "  pai-hoshin objective A1"
    echo "  pai-hoshin bowling A2"
    echo "  pai-hoshin template a3"
}

# Ensure Hoshin directory exists
ensure_dirs() {
    mkdir -p "${HOSHIN_DIR}/bowling-charts"
    mkdir -p "${HOSHIN_DIR}/a3s"
    mkdir -p "${HOSHIN_DIR}/reviews"
}

# Show overall status
show_status() {
    echo -e "${BLUE}ðŸ“Š Hoshin Kanri Status${NC}"
    echo "========================"
    echo ""

    # Count objectives
    if [ -d "${HOSHIN_DIR}/bowling-charts" ]; then
        echo -e "${GREEN}Bowling Charts:${NC}"
        ls -1 "${HOSHIN_DIR}/bowling-charts"/*.md 2>/dev/null | while read f; do
            name=$(basename "$f" .md)
            # Try to extract latest status
            status=$(grep -o 'G\|Y\|R' "$f" 2>/dev/null | tail -1 || echo "?")
            case $status in
                G) echo -e "  ${GREEN}â—${NC} $name" ;;
                Y) echo -e "  ${YELLOW}â—${NC} $name" ;;
                R) echo -e "  ${RED}â—${NC} $name" ;;
                *) echo "  â—‹ $name" ;;
            esac
        done || echo "  No bowling charts found"
    fi

    echo ""

    # Active A3s
    if [ -d "${HOSHIN_DIR}/a3s" ]; then
        echo -e "${YELLOW}Active A3s:${NC}"
        ls -1 "${HOSHIN_DIR}/a3s"/*.md 2>/dev/null | while read f; do
            echo "  - $(basename "$f" .md)"
        done || echo "  No active A3s"
    fi

    echo ""

    # Next review
    echo -e "${BLUE}Next Actions:${NC}"
    echo "  - Process any new Telegram notes: pai-quick inbox"
    echo "  - Review month-end: pai-hoshin review"
}

# Show specific objective
show_objective() {
    local OBJ_ID="${1:-A1}"
    echo -e "${BLUE}Objective: $OBJ_ID${NC}"
    echo "========================"

    BOWLING_FILE="${HOSHIN_DIR}/bowling-charts/${OBJ_ID}-bowling.md"
    if [ -f "$BOWLING_FILE" ]; then
        cat "$BOWLING_FILE"
    else
        echo "No bowling chart found for $OBJ_ID"
        echo ""
        echo "Create one with: pai-hoshin template bowling > $BOWLING_FILE"
    fi
}

# Show bowling chart
show_bowling() {
    local OBJ_ID="${1:-A1}"
    BOWLING_FILE="${HOSHIN_DIR}/bowling-charts/${OBJ_ID}-bowling.md"

    if [ -f "$BOWLING_FILE" ]; then
        echo -e "${BLUE}Bowling Chart: $OBJ_ID${NC}"
        echo ""
        cat "$BOWLING_FILE"
    else
        echo "No bowling chart for $OBJ_ID"
        echo "Use template: pai-hoshin template bowling"
    fi
}

# List A3s
list_a3s() {
    echo -e "${BLUE}Active A3 Problem-Solving${NC}"
    echo "=========================="
    echo ""

    if [ -d "${HOSHIN_DIR}/a3s" ]; then
        for f in "${HOSHIN_DIR}/a3s"/*.md; do
            if [ -f "$f" ]; then
                name=$(basename "$f" .md)
                # Extract problem statement (first line after frontmatter)
                problem=$(grep -A1 "## 1. Problem Statement" "$f" 2>/dev/null | tail -1 | head -c 60)
                echo -e "${YELLOW}$name${NC}"
                echo "  $problem..."
                echo ""
            fi
        done
    else
        echo "No A3s directory. Creating..."
        mkdir -p "${HOSHIN_DIR}/a3s"
        echo "Create first A3 with: pai-hoshin template a3"
    fi
}

# Prep for monthly review
review_prep() {
    echo -e "${BLUE}ðŸ“‹ Monthly Review Preparation${NC}"
    echo "=============================="
    echo ""
    echo "Date: $(date '+%B %Y')"
    echo ""

    echo -e "${GREEN}1. Bowling Charts to Update:${NC}"
    if [ -d "${HOSHIN_DIR}/bowling-charts" ]; then
        ls -1 "${HOSHIN_DIR}/bowling-charts"/*.md 2>/dev/null | while read f; do
            echo "   â–¡ $(basename "$f" .md)"
        done || echo "   (none)"
    fi

    echo ""
    echo -e "${YELLOW}2. A3s Requiring Update:${NC}"
    if [ -d "${HOSHIN_DIR}/a3s" ]; then
        ls -1 "${HOSHIN_DIR}/a3s"/*.md 2>/dev/null | while read f; do
            echo "   â–¡ $(basename "$f" .md)"
        done || echo "   (none)"
    fi

    echo ""
    echo -e "${BLUE}3. Recent Notes to Review:${NC}"
    PROCESSED_DIR="${OBSIDIAN_DIR}/AI-Processed"
    if [ -d "$PROCESSED_DIR" ]; then
        find "$PROCESSED_DIR" -name "*.md" -mtime -30 2>/dev/null | head -10 | while read f; do
            echo "   - $(basename "$f" .md)"
        done
    fi

    echo ""
    echo "---"
    echo "Template: pai-hoshin template monthly-review"
}

# Show template
show_template() {
    local TYPE="${1:-x-matrix}"

    case "$TYPE" in
        x-matrix|xmatrix)
            cat "${TEMPLATES_DIR}/x-matrix.md" 2>/dev/null || echo "Template not found"
            ;;
        bowling|bowling-chart)
            cat "${TEMPLATES_DIR}/bowling-chart.md" 2>/dev/null || echo "Template not found"
            ;;
        a3)
            cat "${TEMPLATES_DIR}/a3-template.md" 2>/dev/null || echo "Template not found"
            ;;
        catchball)
            cat "${TEMPLATES_DIR}/catchball-record.md" 2>/dev/null || echo "Template not found"
            ;;
        monthly|monthly-review|review)
            cat "${TEMPLATES_DIR}/monthly-review.md" 2>/dev/null || echo "Template not found"
            ;;
        annual|annual-planning)
            cat "${TEMPLATES_DIR}/annual-planning.md" 2>/dev/null || echo "Template not found"
            ;;
        excel)
            cat "${TEMPLATES_DIR}/x-matrix-excel.md" 2>/dev/null || echo "Template not found"
            ;;
        ppt|powerpoint)
            cat "${TEMPLATES_DIR}/hoshin-powerpoint.md" 2>/dev/null || echo "Template not found"
            ;;
        *)
            echo "Unknown template: $TYPE"
            echo ""
            echo "Available: x-matrix, bowling, a3, catchball, monthly-review, annual, excel, powerpoint"
            ;;
    esac
}

# Main
ensure_dirs

case "${1:-}" in
    ""|"help"|"-h"|"--help")
        usage
        ;;
    "status")
        show_status
        ;;
    "objective"|"obj")
        show_objective "$2"
        ;;
    "bowling")
        show_bowling "$2"
        ;;
    "a3")
        if [ "$2" = "list" ] || [ -z "$2" ]; then
            list_a3s
        else
            A3_FILE="${HOSHIN_DIR}/a3s/${2}.md"
            if [ -f "$A3_FILE" ]; then
                cat "$A3_FILE"
            else
                echo "A3 not found: $2"
            fi
        fi
        ;;
    "review")
        review_prep
        ;;
    "template"|"tmpl")
        show_template "$2"
        ;;
    *)
        echo "Unknown command: $1"
        usage
        ;;
esac
